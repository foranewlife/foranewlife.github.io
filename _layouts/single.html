---
layout: default
---

{% include base_path %}

{% if page.header.overlay_color or page.header.overlay_image or page.header.image %}
  {% include page__hero.html %}
{% endif %}

{% if page.url != "/" and site.breadcrumbs %}
  {% unless paginator %}
    {% include breadcrumbs.html %}
  {% endunless %}
{% endif %}

<div id="main" role="main">
  {% unless page.url contains "/posts" %}
    {% include sidebar.html %}
  {% endunless %}

  <div class="{% if page.url contains '/posts' %} content-with-sidebar {% else %}  main-content  {% endif %}">
    <article class="{% if page.url contains '/posts' %} main-content {% else %} page {% endif %}" itemscope itemtype="http://schema.org/CreativeWork">
    {% if page.title %}<meta itemprop="headline" content="{{ page.title | markdownify | strip_html | strip_newlines | escape_once }}">{% endif %}
    {% if page.excerpt %}<meta itemprop="description" content="{{ page.excerpt | markdownify | strip_html | strip_newlines | escape_once }}">{% endif %}
    {% if page.date %}<meta itemprop="datePublished" content="{{ page.date | date: "%B %d, %Y" }}">{% endif %}
    {% if page.modified %}<meta itemprop="dateModified" content="{{ page.modified | date: "%B %d, %Y" }}">{% endif %}

    <div class="page__inner-wrap">
      {% unless page.header.overlay_color or page.header.overlay_image %}
        <header>
          {% if page.title %}<h1 class="page__title" itemprop="headline">{{ page.title | markdownify | remove: "<p>" | remove: "</p>" }}</h1>{% endif %}
          {% if page.read_time %}
            <p class="page__meta"><i class="fa fa-clock" aria-hidden="true"></i> {% include read-time.html %}</p>
          {% endif %}

          {% if page.collection == 'teaching' %}
          <p> {{ page.type }}, <i>{{ page.venue }}</i>, {{ page.date | default: "1900-01-01" | date: "%Y" }} </p>
        {% elsif page.venue and page.date %}
          <p>Published in <i>{{ page.venue }}</i>, {{ page.date | default: "1900-01-01" | date: "%Y" }} </p>
        {% elsif page.date %}
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> {{ site.data.ui-text[site.locale].date_label | default: "Published:" }}</strong> <time datetime="{{ page.date | date_to_xmlschema }}">{{ page.date | default: "1900-01-01" | date: "%B %d, %Y" }}</time></p>
        {% endif %}    

        {% if page.modified %}
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> {{ site.data.ui-text[site.locale].modified_label | default: "Modified:" }}</strong> <time datetime="{{ page.modified | date: "%Y-%m-%d" }}">{{ page.modified | date: "%B %d, %Y" }}</time></p>
        {% endif %}

        {% include page__taxonomy.html %}
        
        </header>
      {% endunless %}

      <section class="page__content" itemprop="text">
        {{ content }}

        {% if page.citation and page.paperurl and page.slidesurl and page.bibtexurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.paperurl }}">Download Paper</a> | <a href="{{ page.slidesurl }}">Download Slides</a> | <a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% elsif page.citation and page.paperurl and page.slidesurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.paperurl }}">Download Paper</a> | <a href="{{ page.slidesurl }}">Download Slides</a></p>
        {% elsif page.citation and page.paperurl and page.bibtexurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.paperurl }}">Download Paper</a> | <a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% elsif page.citation and page.paperurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.paperurl }}">Download Paper</a></p>
        {% elsif page.citation and page.slidesurl and page.bibtexurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.slidesurl }}">Download Slides</a> | <a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% elsif page.citation and page.slidesurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.slidesurl }}">Download Slides</a></p>
        {% elsif page.slidesurl and page.bibtexurl %}
          <p style="font-size: smaller"><a href="{{ page.slidesurl }}">Download Slides</a> | <a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% elsif page.paperurl and page.bibtexurl %}
          <p style="font-size: smaller"><a href="{{ page.paperurl }}">Download Paper</a> | <a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% elsif page.citation and page.bibtexurl %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}<br /><a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% elsif page.citation %}
          <p style="font-size: smaller">Recommended citation: {{ page.citation }}</p>
        {% elsif page.slidesurl %}
          <p style="font-size: smaller"><a href="{{ page.slidesurl }}">Download Slides</a></p>
        {% elsif page.bibtexurl %}
          <p style="font-size: smaller"><a href="{{ page.bibtexurl }}">Download Bibtex</a></p>
        {% endif %}

        {% if page.link %}<div><a href="{{ page.link }}" class="btn">{{ site.data.ui-text[site.locale].ext_link_label | default: "Direct Link" }}</a></div>{% endif %}
      </section>

      <footer class="page__meta">
        {% if site.data.ui-text[site.locale].meta_label %}
          <h4 class="page__meta-title">{{ site.data.ui-text[site.locale].meta_label }}</h4>
        {% endif %}
        {% include page__taxonomy.html %}
      </footer>

      {% if page.share %}{% include social-share.html %}{% endif %}

      {% include post_pagination.html %}
    </div>

    {% if site.comments.provider and page.comments %}
      {% include comments.html %}
    {% endif %}

  {% comment %}<!-- only show related on a post page when not disabled -->{% endcomment %}
  {% if page.id and page.related and site.related_posts.size > 0 %}
    <div class="{% if page.url contains '/posts' %} .page__related-full-width {% else %} page__related {% endif %}">
      {% if site.data.ui-text[site.locale].related_label %}
        <h4 class="page__related-title">{{ site.data.ui-text[site.locale].related_label | default: "You May Also Enjoy" }}</h4>
      {% endif %}
      <div class="grid__wrapper">
        {% for post in site.related_posts limit:4 %}
          {% unless post.tags contains "草稿" %}
            {% include archive-single.html type="grid" %}
          {% endunless %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
    </article>
    
    <!-- 文章目录侧边栏 -->
    {% if page.url contains '/posts' %}
    <div class="toc-sidebar">
      <h3 class="toc-title">文章目录</h3>
      <div class="toc-nav">
        <div id="toc-content">
          <!-- 目录内容将由JavaScript动态生成 -->
        </div>
      </div>
    </div>
    
    <!-- 移动端目录切换按钮 -->
    <button id="mobile-toc-toggle" class="mobile-toc-toggle" title="目录">
      <i class="fa fa-list"></i>
    </button>
    {% endif %}
  </div>
</div>

<!-- 回到顶部按钮 -->
<button id="back-to-top" class="back-to-top-btn" title="回到顶部">
  <i class="fa fa-arrow-up"></i>
</button>

<style>
.back-to-top-btn {
  position: fixed;
  bottom: 30px;
  right: 20px;
  width: 50px;
  height: 50px;
  background-color: var(--global-bg-color);
  color: #1976d2;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.back-to-top-btn:hover {
  background-color: var(--global-bg-color);
  color: #1565c0;
  transform: translateY(-2px) scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

.back-to-top-btn.show {
  opacity: 1;
  visibility: visible;
}

.back-to-top-btn:focus {
  outline: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const backToTopBtn = document.getElementById('back-to-top');
  
  // 显示/隐藏按钮
  function toggleBackToTopBtn() {
    if (window.pageYOffset > 300) {
      backToTopBtn.classList.add('show');
    } else {
      backToTopBtn.classList.remove('show');
    }
  }
  
  // 平滑滚动到顶部
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }
  
  // 监听滚动事件
  window.addEventListener('scroll', toggleBackToTopBtn);
  
  // 点击按钮回到顶部
  backToTopBtn.addEventListener('click', scrollToTop);
});

// 文章目录功能
if (document.querySelector('.toc-sidebar')) {
  // 生成目录
  function generateTOC() {
    const content = document.querySelector('.page__content');
    const tocContent = document.getElementById('toc-content');
    
    if (!content || !tocContent) return;
    
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    if (headings.length === 0) {
      document.querySelector('.toc-sidebar').style.display = 'none';
      return;
    }
    
    // 构建层级结构
    const tocTree = buildTOCTree(headings);
    tocTreeGlobal = tocTree; // 保存全局引用
    const tocHTML = generateTOCHTML(tocTree);
    
    tocContent.innerHTML = tocHTML;
  }
  
  // 构建TOC树结构
  function buildTOCTree(headings) {
    const tree = [];
    const stack = [];
    
    headings.forEach((heading, index) => {
      // 为标题添加ID
      if (!heading.id) {
        const text = heading.textContent.trim();
        heading.id = `heading-${index}-${text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').substring(0, 20)}`;
      }
      
      const level = parseInt(heading.tagName.substring(1));
      const text = heading.textContent.trim();
      
      const node = {
        id: heading.id,
        text: text,
        level: level,
        children: []
      };
      
      // 找到合适的父节点
      while (stack.length > 0 && stack[stack.length - 1].level >= level) {
        stack.pop();
      }
      
      if (stack.length === 0) {
        tree.push(node);
      } else {
        stack[stack.length - 1].children.push(node);
      }
      
      stack.push(node);
    });
    
    return tree;
  }
  
  // 用于存储TOC树结构，供父级高亮使用
  let tocTreeGlobal = null;
  
  // 查找节点的所有父级ID
  function findParentIds(nodeId, tree, parents = []) {
    for (let node of tree) {
      if (node.id === nodeId) {
        return parents;
      }
      if (node.children && node.children.length > 0) {
        const result = findParentIds(nodeId, node.children, [...parents, node.id]);
        if (result !== null) {
          return result;
        }
      }
    }
    return null;
  }
  
  // 高亮父级链接
  function highlightParents(currentId) {
    if (!tocTreeGlobal) return;
    
    const parentIds = findParentIds(currentId, tocTreeGlobal);
    if (parentIds) {
      parentIds.forEach(parentId => {
        const parentLink = document.querySelector(`.toc-link[href="#${parentId}"]`);
        if (parentLink) {
          parentLink.classList.add('parent-active');
        }
      });
    }
  }
  
  // 将激活的目录项滚动到可视区域
  function scrollTocToActiveItem(activeLink) {
    const tocNav = document.querySelector('.toc-nav');
    if (!tocNav || !activeLink) return;
    
    const tocNavRect = tocNav.getBoundingClientRect();
    const activeLinkRect = activeLink.getBoundingClientRect();
    
    // 计算相对于 toc-nav 容器的位置
    const relativeTop = activeLinkRect.top - tocNavRect.top + tocNav.scrollTop;
    const relativeBottom = activeLinkRect.bottom - tocNavRect.top + tocNav.scrollTop;
    
    // 检查是否需要滚动
    const containerHeight = tocNav.clientHeight;
    const scrollTop = tocNav.scrollTop;
    const visibleTop = scrollTop;
    const visibleBottom = scrollTop + containerHeight;
    
    // 如果激活项在可视区域上方
    if (relativeTop < visibleTop) {
      tocNav.scrollTo({
        top: relativeTop - 20, // 添加一些边距
        behavior: 'smooth'
      });
    }
    // 如果激活项在可视区域下方
    else if (relativeBottom > visibleBottom) {
      tocNav.scrollTo({
        top: relativeBottom - containerHeight + 20, // 添加一些边距
        behavior: 'smooth'
      });
    }
  }
  
  // 生成TOC HTML
  function generateTOCHTML(tree) {
    if (!tree || tree.length === 0) return '';
    
    let html = '<ul class="toc-list">';
    
    tree.forEach(node => {
      const hasChildren = node.children && node.children.length > 0;
      
      html += `<li class="toc-level-${node.level} ${hasChildren ? 'toc-has-children' : ''}">`;
      
      html += `<a href="#${node.id}" class="toc-link">`;
      
      if (hasChildren) {
        html += `<span class="toc-toggle" data-target="toc-${node.id}">
          <i class="fa fa-chevron-down"></i>
        </span>`;
      }
      
      html += `${node.text}</a>`;
      
      if (hasChildren) {
        html += `<div class="toc-children" id="toc-${node.id}">
          ${generateTOCHTML(node.children)}
        </div>`;
      }
      
      html += '</li>';
    });
    
    html += '</ul>';
    return html;
  }
  
  // 滚动监听和高亮
  function updateTOCHighlight() {
    const headings = document.querySelectorAll('.page__content h1[id], .page__content h2[id], .page__content h3[id], .page__content h4[id], .page__content h5[id], .page__content h6[id]');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    let currentHeading = null;
    const scrollTop = window.pageYOffset + 100;
    
    // 找到当前可见的标题
    for (let i = headings.length - 1; i >= 0; i--) {
      if (headings[i].offsetTop <= scrollTop) {
        currentHeading = headings[i];
        break;
      }
    }
    
    // 更新高亮
    tocLinks.forEach(link => {
      link.classList.remove('active');
      link.classList.remove('parent-active');
    });
    
    if (currentHeading) {
      const activeLink = document.querySelector(`.toc-link[href="#${currentHeading.id}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
        
        // 高亮父级链接 - 使用简化的方法
        highlightParents(currentHeading.id);
        
        // 滚动目录到可视区域
        scrollTocToActiveItem(activeLink);
      }
    }
  }
  
  // 处理折叠切换
  function handleTOCToggle(e) {
    if (e.target.closest('.toc-toggle')) {
      e.preventDefault();
      const toggle = e.target.closest('.toc-toggle');
      const targetId = toggle.getAttribute('data-target');
      const children = document.getElementById(targetId);
      const icon = toggle.querySelector('i');
      
      if (children) {
        children.classList.toggle('collapsed');
        icon.classList.toggle('fa-chevron-down');
        icon.classList.toggle('fa-chevron-right');
      }
    }
  }
  
  // 平滑滚动到标题
  function handleTOCClick(e) {
    if (e.target.classList.contains('toc-link')) {
      e.preventDefault();
      const targetId = e.target.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        window.scrollTo({
          top: targetElement.offsetTop - 80,
          behavior: 'smooth'
        });
        
        // 立即更新高亮状态和目录滚动
        setTimeout(() => {
          updateTOCHighlight();
        }, 100);
      }
    }
  }
  
  // 移动端目录切换功能
  function initMobileTOC() {
    const mobileToggle = document.getElementById('mobile-toc-toggle');
    const tocSidebar = document.querySelector('.toc-sidebar');
    
    // 自动配置top值
    function updateTocPosition() {
      const masthead = document.querySelector('.masthead');
      if (masthead && tocSidebar) {
        const mastheadHeight = masthead.offsetHeight;
        tocSidebar.style.top = mastheadHeight + 'px';
        tocSidebar.style.height = `calc(100vh - ${mastheadHeight}px)`;
      }
    }
    
    // 页面加载后和窗口大小改变时更新位置
    setTimeout(updateTocPosition, 100); // 确保DOM完全加载
    window.addEventListener('resize', updateTocPosition);
    
    if (mobileToggle && tocSidebar) {
      // 点击按钮切换目录显示
      mobileToggle.addEventListener('click', function() {
        tocSidebar.classList.toggle('show');
        
        // 更换图标
        const icon = mobileToggle.querySelector('i');
        if (tocSidebar.classList.contains('show')) {
          icon.className = 'fa fa-times';
        } else {
          icon.className = 'fa fa-list';
        }
      });
      
      // 点击目录项后自动关闭移动端目录
      tocSidebar.addEventListener('click', function(e) {
        if (e.target.classList.contains('toc-link') && window.innerWidth <= 768) {
          tocSidebar.classList.remove('show');
          const icon = mobileToggle.querySelector('i');
          icon.className = 'fa fa-list';
        }
      });
      
      // 点击遮罩关闭目录
      document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768 && 
            tocSidebar.classList.contains('show') && 
            !tocSidebar.contains(e.target) && 
            !mobileToggle.contains(e.target)) {
          tocSidebar.classList.remove('show');
          const icon = mobileToggle.querySelector('i');
          icon.className = 'fa fa-list';
        }
      });
    }
  }
  
  // 初始化
  generateTOC();
  initMobileTOC();
  window.addEventListener('scroll', updateTOCHighlight, { passive: true });
  
  // 绑定点击事件（包括折叠和跳转）
  const tocSidebar = document.querySelector('.toc-sidebar');
  tocSidebar.addEventListener('click', handleTOCToggle);
  tocSidebar.addEventListener('click', handleTOCClick);
  
  // 初始高亮
  setTimeout(updateTOCHighlight, 100);
}
</script>
